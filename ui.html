<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>DC UI Toolkit</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Inter', sans-serif;
      color: #333;
      font-size: 12px;
      margin: 0;
      padding: 0;
      overflow: hidden;
    }
    
    #root {
      width: 100%;
      height: 100vh;
      display: flex;
    }
    
    .sidebar {
      width: 64px;
      height: 100vh;
      border-right: 1px solid #E5E5E5;
      background-color: #FFFFFF;
    }
    
    .sidebar-tab {
      width: 64px;
      height: 64px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      position: relative;
      border-bottom: 1px solid #E5E5E5;
    }
    
    .sidebar-tab.active {
      background-color: #EDEDED;
    }
    
    .sidebar-tab.active::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      width: 4px;
      height: 100%;
      background-color: #000;
    }
    
    .sidebar-tab-icon {
      width: 24px;
      height: 24px;
      background-color: #000;
      border-radius: 2px;
    }
    
    .main-content {
      flex: 1;
      padding: 16px;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    
    .header {
      display: flex;
      flex-direction: column;
      margin-bottom: 16px;
    }
    
    .plugin-name {
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 12px;
    }
    
    .search-container {
      position: relative;
      width: 100%;
    }
    
    .search-input {
      width: 100%;
      padding: 8px 12px 8px 32px;
      border: 1px solid #E5E5E5;
      border-radius: 6px;
      font-size: 12px;
    }
    
    .search-icon {
      position: absolute;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      color: #888;
    }
    
    .component-list {
      overflow-y: auto;
      flex-grow: 1;
      margin-top: 16px;
      
      /* éšè—æ»šåŠ¨æ¡ä½†ä¿ç•™åŠŸèƒ½ */
      scrollbar-width: none; /* Firefox */
      -ms-overflow-style: none; /* IE and Edge */
    }
    
    /* ä¸º Webkit æµè§ˆå™¨éšè—æ»šåŠ¨æ¡ */
    .component-list::-webkit-scrollbar {
      display: none;
    }
    
    .component-item {
      display: flex;
      align-items: center;
      padding: 8px;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    
    .component-item:hover {
      background-color: #F5F5F5;
    }
    
    .component-thumbnail {
      width: 40px;
      height: 40px;
      background-color: #E5E5E5;
      border-radius: 4px;
      margin-right: 12px;
      background-size: cover;
      background-position: center;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      color: #888;
    }
    
    .component-info {
      flex: 1;
    }
    
    .component-name {
      font-weight: 500;
    }
    
    .component-type {
      font-size: 10px;
      color: #888;
      margin-top: 2px;
    }
    
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: #888;
      text-align: center;
    }
    
    .empty-state-icon {
      font-size: 24px;
      margin-bottom: 8px;
    }
    
    .divider {
      height: 1px;
      background-color: #E5E5E5;
      margin: 8px 0;
    }
    
    .loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: #888;
      text-align: center;
    }
    
    .loading-spinner {
      width: 24px;
      height: 24px;
      border: 2px solid #E5E5E5;
      border-top: 2px solid #18A0FB;
      border-radius: 50%;
      margin-bottom: 8px;
      animation: spin 1s linear infinite;
    }
    
    .progress-bar-container {
      width: 100%;
      max-width: 200px;
      height: 4px;
      background-color: #E5E5E5;
      border-radius: 2px;
      margin-top: 8px;
      overflow: hidden;
    }
    
    .progress-bar {
      height: 100%;
      background-color: #18A0FB;
      transition: width 0.3s ease;
    }
    
    .load-more {
      padding: 12px;
      text-align: center;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
  <script>
    // åˆå§‹åŒ–å˜é‡
    let components = [];
    let filteredComponents = [];
    let searchTerm = '';
    let isLoading = true;
    let hasMoreComponents = true;
    
    // åœ¨ DOM åŠ è½½å®Œæˆåæ‰§è¡Œ
    document.addEventListener('DOMContentLoaded', function() {
      // è·å– DOM å…ƒç´ 
      const componentList = document.getElementById('component-list');
      const searchInput = document.getElementById('search-input');
      
      // ç›‘å¬æ»šåŠ¨äº‹ä»¶ï¼Œå®ç°æ— é™æ»šåŠ¨
      componentList.addEventListener('scroll', function() {
        if (isLoading || !hasMoreComponents) return;
        
        const scrollHeight = componentList.scrollHeight;
        const scrollTop = componentList.scrollTop;
        const clientHeight = componentList.clientHeight;
        
        // å½“æ»šåŠ¨åˆ°åº•éƒ¨æ—¶ï¼ŒåŠ è½½æ›´å¤šç»„ä»¶
        if (scrollHeight - scrollTop - clientHeight < 100) {
          loadMoreComponents();
        }
      });
      
      // åŠ è½½æ›´å¤šç»„ä»¶
      function loadMoreComponents() {
        if (isLoading || !hasMoreComponents) return;
        
        isLoading = true;
        
        // æ˜¾ç¤ºåŠ è½½ä¸­
        showLoadingMore();
        
        // è¯·æ±‚åŠ è½½æ›´å¤šç»„ä»¶
        parent.postMessage({ 
          pluginMessage: { 
            type: 'load-more-components'
          } 
        }, '*');
      }
      
      // æ˜¾ç¤º"åŠ è½½æ›´å¤š"çš„åŠ è½½çŠ¶æ€
      function showLoadingMore() {
        // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨åŠ è½½æ›´å¤šå…ƒç´ 
        let loadMoreEl = document.querySelector('.load-more');
        
        if (!loadMoreEl) {
          loadMoreEl = document.createElement('div');
          loadMoreEl.className = 'load-more';
          loadMoreEl.innerHTML = `
            <div class="loading">
              <div class="loading-spinner"></div>
              <p>åŠ è½½æ›´å¤šç»„ä»¶...</p>
            </div>
          `;
          componentList.appendChild(loadMoreEl);
        }
      }
      
      // éšè—"åŠ è½½æ›´å¤š"çš„åŠ è½½çŠ¶æ€
      function hideLoadingMore() {
        const loadMoreEl = document.querySelector('.load-more');
        if (loadMoreEl) {
          loadMoreEl.remove();
        }
      }
      
      // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
      function showLoading(message, progress = 0) {
        componentList.innerHTML = `
          <div class="loading">
            <div class="loading-spinner"></div>
            <p>${message}</p>
            <div class="progress-bar-container">
              <div class="progress-bar" style="width: ${progress * 100}%"></div>
            </div>
          </div>
        `;
      }
      
      // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
      function showError(message) {
        componentList.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">âŒ</div>
            <p>${message}</p>
            <button style="margin-top: 12px; padding: 6px 12px;" onclick="refreshComponents()">é‡è¯•</button>
          </div>
        `;
      }
      
      // æ›´æ–°ç»„ä»¶åˆ—è¡¨
      function updateComponentList(clearFirst = true) {
        if (clearFirst) {
          componentList.innerHTML = '';
        }
        
        // å¦‚æœæ²¡æœ‰ç»„ä»¶
        if (filteredComponents.length === 0) {
          componentList.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">ğŸ”</div>
              <p>æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„ç»„ä»¶</p>
            </div>
          `;
          return;
        }
        
        // å¦‚æœæ˜¯æ¸…ç©ºé‡å»ºï¼Œåˆ™åˆ›å»ºæ‰€æœ‰ç»„ä»¶
        if (clearFirst) {
          filteredComponents.forEach(createComponentItem);
        } else {
          // å¦åˆ™åªæ·»åŠ æ–°ç»„ä»¶
          const existingCount = componentList.querySelectorAll('.component-item').length;
          filteredComponents.slice(existingCount).forEach(createComponentItem);
        }
      }
      
      // åˆ›å»ºç»„ä»¶é¡¹
      function createComponentItem(component) {
        const componentItem = document.createElement('div');
        componentItem.className = 'component-item';
        componentItem.dataset.id = component.id;
        
        const thumbnail = document.createElement('div');
        thumbnail.className = 'component-thumbnail';
        
        // å¦‚æœæœ‰ç¼©ç•¥å›¾ï¼Œè®¾ç½®èƒŒæ™¯å›¾ï¼Œå¦åˆ™ä½¿ç”¨å ä½ç¬¦
        if (component.thumbnail) {
          thumbnail.style.backgroundImage = `url(data:image/png;base64,${component.thumbnail})`;
        } else {
          // ä½¿ç”¨ç»„ä»¶åç§°çš„ç¬¬ä¸€ä¸ªå­—ç¬¦ä½œä¸ºå ä½ç¬¦
          const firstChar = component.name.charAt(0).toUpperCase();
          thumbnail.textContent = firstChar;
        }
        
        const nameContainer = document.createElement('div');
        nameContainer.className = 'component-info';
        
        const name = document.createElement('div');
        name.className = 'component-name';
        name.textContent = component.name;
        
        nameContainer.appendChild(name);
        
        // æ˜¾ç¤ºç»„ä»¶ç±»å‹
        const type = document.createElement('div');
        type.className = 'component-type';
        type.textContent = component.type === 'COMPONENT' ? 'ç»„ä»¶' : 
                           component.type === 'COMPONENT_SET' ? 'ç»„ä»¶é›†' : 'ç»„ä»¶';
        nameContainer.appendChild(type);
        
        componentItem.appendChild(thumbnail);
        componentItem.appendChild(nameContainer);
        
        // æ·»åŠ ç‚¹å‡»äº‹ä»¶
        componentItem.addEventListener('click', () => {
          parent.postMessage({ 
            pluginMessage: { 
              type: 'insert-component', 
              componentId: component.id
            } 
          }, '*');
        });
        
        componentList.appendChild(componentItem);
      }
      
      // åˆ·æ–°ç»„ä»¶
      window.refreshComponents = function() {
        components = [];
        filteredComponents = [];
        showLoading('æ­£åœ¨é‡æ–°åŠ è½½ç»„ä»¶...');
        
        parent.postMessage({ 
          pluginMessage: { 
            type: 'refresh-components'
          } 
        }, '*');
      }
      
      // ç›‘å¬æ¥è‡ªæ’ä»¶çš„æ¶ˆæ¯
      window.onmessage = (event) => {
        const msg = event.data.pluginMessage;
        
        if (!msg) return;
        
        switch (msg.type) {
          case 'loading-status':
            showLoading(msg.message, msg.progress);
            break;
            
          case 'components-page-loaded':
            isLoading = false;
            hideLoadingMore();
            
            // æ·»åŠ æ–°ç»„ä»¶åˆ°åˆ—è¡¨
            const newComponents = msg.components;
            components = [...components, ...newComponents];
            
            // åº”ç”¨æœç´¢è¿‡æ»¤
            if (searchTerm.trim() === '') {
              filteredComponents = [...components];
            } else {
              filteredComponents = components.filter(component => 
                component.name.toLowerCase().includes(searchTerm.toLowerCase())
              );
            }
            
            // æ›´æ–°ç»„ä»¶åˆ—è¡¨
            updateComponentList(msg.currentPage === 1);
            
            // æ›´æ–°æ˜¯å¦æœ‰æ›´å¤šç»„ä»¶
            hasMoreComponents = msg.hasMore;
            break;
            
          case 'component-inserted':
            if (msg.success) {
              console.log('ç»„ä»¶æ’å…¥æˆåŠŸ:', msg.componentId);
            } else {
              console.error('ç»„ä»¶æ’å…¥å¤±è´¥:', msg.error);
              alert('æ— æ³•æ’å…¥ç»„ä»¶: ' + msg.error);
            }
            break;
            
          case 'initialization-error':
            showError(msg.error);
            break;
            
          case 'page-load-error':
            isLoading = false;
            hideLoadingMore();
            alert('åŠ è½½ç»„ä»¶å¤±è´¥: ' + msg.error);
            break;
        }
      };
      
      // ä¾§è¾¹æ  Tab åˆ‡æ¢
      const sidebarTabs = document.querySelectorAll('.sidebar-tab');
      sidebarTabs.forEach(tab => {
        tab.addEventListener('click', function() {
          sidebarTabs.forEach(t => t.classList.remove('active'));
          this.classList.add('active');
        });
      });
      
      // æœç´¢åŠŸèƒ½
      searchInput.addEventListener('input', function() {
        searchTerm = this.value.toLowerCase();
        
        if (searchTerm.trim() === '') {
          filteredComponents = [...components];
        } else {
          filteredComponents = components.filter(component => 
            component.name.toLowerCase().includes(searchTerm)
          );
        }
        
        updateComponentList();
      });
    });
  </script>
</head>
<body>
  <div id="root">
    <div class="sidebar">
      <div class="sidebar-tab active">
        <div class="sidebar-tab-icon"></div>
      </div>
      <div class="sidebar-tab">
        <div class="sidebar-tab-icon"></div>
      </div>
    </div>
    <div class="main-content">
      <div class="header">
        <div class="plugin-name">DC UI Toolkit</div>
        <div class="search-container">
          <span class="search-icon">ğŸ”</span>
          <input type="text" id="search-input" class="search-input" placeholder="æœç´¢ç»„ä»¶...">
        </div>
      </div>
      <div id="component-list" class="component-list">
        <!-- ç»„ä»¶åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
        <div class="loading">
          <div class="loading-spinner"></div>
          <p>æ­£åœ¨åŠ è½½ç»„ä»¶...</p>
        </div>
      </div>
    </div>
  </div>
</body>
</html>
